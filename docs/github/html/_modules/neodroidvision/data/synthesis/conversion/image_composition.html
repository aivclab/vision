
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>neodroidvision.data.synthesis.conversion.image_composition &#8212; neodroidvision 0.2.9 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/graphviz.css" />
    <script data-url_root="../../../../../" id="documentation_options" src="../../../../../_static/documentation_options.js"></script>
    <script src="../../../../../_static/jquery.js"></script>
    <script src="../../../../../_static/underscore.js"></script>
    <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../../../_static/doctools.js"></script>
    <link rel="canonical" href="Neodroid.github.io/neodroidvision/_modules/neodroidvision/data/synthesis/conversion/image_composition.html" />
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for neodroidvision.data.synthesis.conversion.image_composition</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageEnhance</span>
<span class="kn">from</span> <span class="nn">draugr.visualisation</span> <span class="kn">import</span> <span class="n">progress_bar</span>

<span class="kn">from</span> <span class="nn">neodroidvision.data.synthesis.conversion.mnist.json_generation.mask_json_utilities</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">MaskJsonUtils</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ImageComposition&quot;</span><span class="p">]</span>


<div class="viewcode-block" id="ImageComposition"><a class="viewcode-back" href="../../../../../generated/neodroidvision.data.synthesis.conversion.image_composition.ImageComposition.html#neodroidvision.data.synthesis.conversion.image_composition.ImageComposition">[docs]</a><span class="k">class</span> <span class="nc">ImageComposition</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Composes images together in random ways, applying transformations to the foreground to create a</span>
<span class="sd">    synthetic</span>
<span class="sd">      combined image.&quot;&quot;&quot;</span>

    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="ImageComposition.__init__"><a class="viewcode-back" href="../../../../../generated/neodroidvision.data.synthesis.conversion.image_composition.ImageComposition.html#neodroidvision.data.synthesis.conversion.image_composition.ImageComposition.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allowed_output_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;.png&quot;</span><span class="p">,</span> <span class="s2">&quot;.jpg&quot;</span><span class="p">,</span> <span class="s2">&quot;.jpeg&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allowed_background_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;.png&quot;</span><span class="p">,</span> <span class="s2">&quot;.jpg&quot;</span><span class="p">,</span> <span class="s2">&quot;.jpeg&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zero_padding</span> <span class="o">=</span> <span class="mi">8</span>  <span class="c1"># 00000027.png, supports up to 100 million images</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_foregrounds</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_colors</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)]</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_colors</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_foregrounds</span>
        <span class="p">),</span> <span class="s2">&quot;length of mask_colors should be &gt;= max_foregrounds&quot;</span></div>

    <span class="k">def</span> <span class="nf">_validate_and_process_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="c1"># Validates input arguments and sets up class variables</span>
        <span class="c1"># Args:</span>
        <span class="c1">#     args: the ArgumentParser command line arguments</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">silent</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">silent</span>

        <span class="c1"># Validate the count</span>
        <span class="k">assert</span> <span class="n">args</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;count must be greater than 0&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">count</span>

        <span class="c1"># Validate the width and height</span>
        <span class="k">assert</span> <span class="n">args</span><span class="o">.</span><span class="n">_width</span> <span class="o">&gt;=</span> <span class="mi">64</span><span class="p">,</span> <span class="s2">&quot;width must be greater than 64&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">_width</span>
        <span class="k">assert</span> <span class="n">args</span><span class="o">.</span><span class="n">_height</span> <span class="o">&gt;=</span> <span class="mi">64</span><span class="p">,</span> <span class="s2">&quot;height must be greater than 64&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">_height</span>

        <span class="c1"># Validate and process the output type</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">output_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_type</span> <span class="o">=</span> <span class="s2">&quot;.jpg&quot;</span>  <span class="c1"># default</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">output_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_type</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;.</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">output_type</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_output_types</span><span class="p">,</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;output_type is not supported: &quot;</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_type</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Validate and process output and input directories</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_and_process_output_directory</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_and_process_input_directory</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_validate_and_process_output_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">images_output_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;images&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">masks_output_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;masks&quot;</span>

        <span class="c1"># Create directories</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">images_output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">masks_output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">silent</span><span class="p">:</span>
            <span class="c1"># Check for existing contents in the images directory</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">images_output_dir</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
                <span class="c1"># We found something, check if the user wants to overwrite files or quit</span>
                <span class="n">should_continue</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
                    <span class="s2">&quot;output_dir is not empty, files may be overwritten.</span><span class="se">\n</span><span class="s2">Continue (y/n)? &quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">should_continue</span> <span class="o">!=</span> <span class="s2">&quot;y&quot;</span> <span class="ow">and</span> <span class="n">should_continue</span> <span class="o">!=</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
                    <span class="n">quit</span><span class="p">()</span>
                <span class="k">break</span>

    <span class="k">def</span> <span class="nf">_validate_and_process_input_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">input_dir</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">(),</span> <span class="sa">f</span><span class="s2">&quot;input_dir does not exist: </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">input_dir</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dir</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;foregrounds&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">foregrounds_dir</span> <span class="o">=</span> <span class="n">x</span>
            <span class="k">elif</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;backgrounds&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">backgrounds_dir</span> <span class="o">=</span> <span class="n">x</span>

        <span class="k">assert</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">foregrounds_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">),</span> <span class="s2">&quot;foregrounds subdirectory was not found in the input_dir&quot;</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">backgrounds_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">),</span> <span class="s2">&quot;backgrounds subdirectory was not found in the input_dir&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_and_process_foregrounds</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_and_process_backgrounds</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_validate_and_process_foregrounds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Validates input foregrounds and processes them into a foregrounds dictionary.</span>
        <span class="c1"># Expected directory structure:</span>
        <span class="c1"># + foregrounds_dir</span>
        <span class="c1">#     + super_category_dir</span>
        <span class="c1">#         + category_dir</span>
        <span class="c1">#             + foreground_image.png</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">foregrounds_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">super_category_dir</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">foregrounds_dir</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">super_category_dir</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;file found in foregrounds directory (expected super-category directories), ignoring: &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">super_category_dir</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># This is a super category directory</span>
            <span class="k">for</span> <span class="n">category_dir</span> <span class="ow">in</span> <span class="n">super_category_dir</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">category_dir</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;file found in super category directory (expected category directories), ignoring: &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">category_dir</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                    <span class="k">continue</span>

                <span class="c1"># This is a category directory</span>
                <span class="k">for</span> <span class="n">image_file</span> <span class="ow">in</span> <span class="n">category_dir</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">image_file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;a directory was found inside a category directory, ignoring: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">image_file</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">image_file</span><span class="o">.</span><span class="n">suffix</span> <span class="o">!=</span> <span class="s2">&quot;.png&quot;</span><span class="p">:</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;foreground must be a .png file, skipping: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">image_file</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="c1"># Valid foreground image, add to foregrounds_dict</span>
                    <span class="n">super_category</span> <span class="o">=</span> <span class="n">super_category_dir</span><span class="o">.</span><span class="n">name</span>
                    <span class="n">category</span> <span class="o">=</span> <span class="n">category_dir</span><span class="o">.</span><span class="n">name</span>

                    <span class="k">if</span> <span class="n">super_category</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">foregrounds_dict</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">foregrounds_dict</span><span class="p">[</span><span class="n">super_category</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">category</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">foregrounds_dict</span><span class="p">[</span><span class="n">super_category</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">foregrounds_dict</span><span class="p">[</span><span class="n">super_category</span><span class="p">][</span><span class="n">category</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">foregrounds_dict</span><span class="p">[</span><span class="n">super_category</span><span class="p">][</span><span class="n">category</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image_file</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">foregrounds_dict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;no valid foregrounds were found&quot;</span>

    <span class="k">def</span> <span class="nf">_validate_and_process_backgrounds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backgrounds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">image_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">backgrounds_dir</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">image_file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;a directory was found inside the backgrounds directory, ignoring: </span><span class="si">{</span><span class="n">image_file</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">image_file</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_background_types</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;background must match an accepted type </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allowed_background_types</span><span class="p">)</span><span class="si">}</span><span class="s2">, ignoring: &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">image_file</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Valid file, add to background list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">backgrounds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image_file</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backgrounds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;no valid backgrounds were found&quot;</span>

    <span class="k">def</span> <span class="nf">_generate_images</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Generates a number of images and creates segmentation masks, then</span>
        <span class="c1"># saves a mask_definitions.json file that describes the dataset.</span>
        <span class="k">if</span> <span class="n">ImageComposition</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="si">}</span><span class="s2"> images with masks...&quot;</span><span class="p">)</span>

        <span class="n">mju</span> <span class="o">=</span> <span class="n">MaskJsonUtils</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)</span>

        <span class="c1"># Create all images/masks (with tqdm to have a progress bar)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">progress_bar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">)):</span>
            <span class="c1"># Randomly choose a background</span>
            <span class="n">background_path</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backgrounds</span><span class="p">)</span>

            <span class="n">num_foregrounds</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_foregrounds</span><span class="p">)</span>
            <span class="n">foregrounds</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">fg_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_foregrounds</span><span class="p">):</span>
                <span class="c1"># Randomly choose a foreground</span>
                <span class="n">super_category</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">foregrounds_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                <span class="n">category</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
                    <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">foregrounds_dict</span><span class="p">[</span><span class="n">super_category</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="p">)</span>
                <span class="n">foreground_path</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">foregrounds_dict</span><span class="p">[</span><span class="n">super_category</span><span class="p">][</span><span class="n">category</span><span class="p">]</span>
                <span class="p">)</span>

                <span class="c1"># Get the color</span>
                <span class="n">mask_rgb_color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_colors</span><span class="p">[</span><span class="n">fg_i</span><span class="p">]</span>

                <span class="n">foregrounds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;super_category&quot;</span><span class="p">:</span> <span class="n">super_category</span><span class="p">,</span>
                        <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="n">category</span><span class="p">,</span>
                        <span class="s2">&quot;foreground_path&quot;</span><span class="p">:</span> <span class="n">foreground_path</span><span class="p">,</span>
                        <span class="s2">&quot;mask_rgb_color&quot;</span><span class="p">:</span> <span class="n">mask_rgb_color</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>

            <span class="c1"># Compose foregrounds and background</span>
            <span class="n">composite</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compose_images</span><span class="p">(</span><span class="n">foregrounds</span><span class="p">,</span> <span class="n">background_path</span><span class="p">)</span>

            <span class="c1"># Create the file name (used for both composite and mask)</span>
            <span class="n">save_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">0</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">zero_padding</span><span class="si">}}</span><span class="s2">&quot;</span>  <span class="c1"># e.g. 00000023.jpg</span>

            <span class="c1"># Save composite image to the images sub-directory</span>
            <span class="n">composite_filename</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">save_filename</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_type</span><span class="si">}</span><span class="s2">&quot;</span>  <span class="c1"># e.g. 00000023.jpg</span>
            <span class="p">)</span>
            <span class="n">composite_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;images&quot;</span> <span class="o">/</span> <span class="n">composite_filename</span>  <span class="c1"># e.g.</span>
            <span class="c1"># my_output_dir/images/00000023.jpg</span>
            <span class="n">composite</span> <span class="o">=</span> <span class="n">composite</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">)</span>  <span class="c1"># remove alpha</span>
            <span class="n">composite</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">composite_path</span><span class="p">)</span>

            <span class="c1"># Save the mask image to the masks sub-directory</span>
            <span class="n">mask_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">save_filename</span><span class="si">}</span><span class="s2">.png&quot;</span>  <span class="c1"># masks are always png to avoid lossy compression</span>
            <span class="n">mask_path</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;masks&quot;</span> <span class="o">/</span> <span class="n">mask_filename</span>
            <span class="p">)</span>  <span class="c1"># e.g. my_output_dir/masks/00000023.png</span>
            <span class="n">mask</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">mask_path</span><span class="p">)</span>

            <span class="n">color_categories</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">fg</span> <span class="ow">in</span> <span class="n">foregrounds</span><span class="p">:</span>
                <span class="c1"># Add category and color info</span>
                <span class="n">mju</span><span class="o">.</span><span class="n">add_category</span><span class="p">(</span><span class="n">fg</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">],</span> <span class="n">fg</span><span class="p">[</span><span class="s2">&quot;super_category&quot;</span><span class="p">])</span>
                <span class="n">color_categories</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">fg</span><span class="p">[</span><span class="s2">&quot;mask_rgb_color&quot;</span><span class="p">])]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="n">fg</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;super_category&quot;</span><span class="p">:</span> <span class="n">fg</span><span class="p">[</span><span class="s2">&quot;super_category&quot;</span><span class="p">],</span>
                <span class="p">}</span>

            <span class="c1"># Add the mask to MaskJsonUtils</span>
            <span class="n">mju</span><span class="o">.</span><span class="n">add_mask</span><span class="p">(</span>
                <span class="n">composite_path</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
                <span class="n">mask_path</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
                <span class="n">color_categories</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Write masks to json</span>
        <span class="n">mju</span><span class="o">.</span><span class="n">write_masks_to_json</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_compose_images</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foregrounds</span><span class="p">,</span> <span class="n">background_path</span><span class="p">):</span>
        <span class="c1"># Composes a foreground image and a background image and creates a segmentation mask</span>
        <span class="c1"># using the specified color. Validation should already be done by now.</span>
        <span class="c1"># Args:</span>
        <span class="c1">#     foregrounds: a list of dicts with format:</span>
        <span class="c1">#       [{</span>
        <span class="c1">#           &#39;super_category&#39;:super_category,</span>
        <span class="c1">#           &#39;category&#39;:category,</span>
        <span class="c1">#           &#39;foreground_path&#39;:foreground_path,</span>
        <span class="c1">#           &#39;mask_rgb_color&#39;:mask_rgb_color</span>
        <span class="c1">#       },...]</span>
        <span class="c1">#     background_path: the path to a valid background image</span>
        <span class="c1"># Returns:</span>
        <span class="c1">#     composite: the composed image</span>
        <span class="c1">#     mask: the mask image</span>

        <span class="c1"># Open background and convert to RGBA</span>
        <span class="n">background</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">background_path</span><span class="p">)</span>
        <span class="n">background</span> <span class="o">=</span> <span class="n">background</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;RGBA&quot;</span><span class="p">)</span>

        <span class="c1"># Crop background to desired size (self.width x self.height), randomly positioned</span>
        <span class="n">bg_width</span><span class="p">,</span> <span class="n">bg_height</span> <span class="o">=</span> <span class="n">background</span><span class="o">.</span><span class="n">size</span>
        <span class="n">max_crop_x_pos</span> <span class="o">=</span> <span class="n">bg_width</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span>
        <span class="n">max_crop_y_pos</span> <span class="o">=</span> <span class="n">bg_height</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span>
        <span class="k">assert</span> <span class="n">max_crop_x_pos</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;desired width, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="si">}</span><span class="s2">, is greater than background width, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bg_width</span><span class="si">}</span><span class="s2">, for </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">background_path</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="n">max_crop_y_pos</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;desired height, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="si">}</span><span class="s2">, is greater than backgrou&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;nd height, </span><span class="si">{</span><span class="n">bg_height</span><span class="si">}</span><span class="s2">, for </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">background_path</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">crop_x_pos</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_crop_x_pos</span><span class="p">)</span>
        <span class="n">crop_y_pos</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_crop_y_pos</span><span class="p">)</span>
        <span class="n">composite</span> <span class="o">=</span> <span class="n">background</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span>
            <span class="p">(</span><span class="n">crop_x_pos</span><span class="p">,</span> <span class="n">crop_y_pos</span><span class="p">,</span> <span class="n">crop_x_pos</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">crop_y_pos</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">composite_mask</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">,</span> <span class="n">composite</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">fg</span> <span class="ow">in</span> <span class="n">foregrounds</span><span class="p">:</span>
            <span class="n">fg_path</span> <span class="o">=</span> <span class="n">fg</span><span class="p">[</span><span class="s2">&quot;foreground_path&quot;</span><span class="p">]</span>

            <span class="c1"># Perform transformations</span>
            <span class="n">fg_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_foreground</span><span class="p">(</span><span class="n">fg</span><span class="p">,</span> <span class="n">fg_path</span><span class="p">)</span>

            <span class="c1"># Choose a random x,y position for the foreground</span>
            <span class="n">max_x_position</span> <span class="o">=</span> <span class="n">composite</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">fg_image</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">max_y_position</span> <span class="o">=</span> <span class="n">composite</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">fg_image</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">max_x_position</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">max_y_position</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;foreground </span><span class="si">{</span><span class="n">fg_path</span><span class="si">}</span><span class="s2"> is too big (</span><span class="si">{</span><span class="n">fg_image</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">fg_image</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">) for the requested&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;output size (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="si">}</span><span class="s2">), check your input parameters&quot;</span>
            <span class="p">)</span>
            <span class="n">paste_position</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_x_position</span><span class="p">),</span>
                <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_y_position</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="c1"># Create a new foreground image as large as the composite and paste it on top</span>
            <span class="n">new_fg_image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;RGBA&quot;</span><span class="p">,</span> <span class="n">composite</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">new_fg_image</span><span class="o">.</span><span class="n">paste</span><span class="p">(</span><span class="n">fg_image</span><span class="p">,</span> <span class="n">paste_position</span><span class="p">)</span>

            <span class="c1"># Extract the alpha channel from the foreground and paste it into a new image the size of the composite</span>
            <span class="n">alpha_mask</span> <span class="o">=</span> <span class="n">fg_image</span><span class="o">.</span><span class="n">getchannel</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">new_alpha_mask</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;L&quot;</span><span class="p">,</span> <span class="n">composite</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">new_alpha_mask</span><span class="o">.</span><span class="n">paste</span><span class="p">(</span><span class="n">alpha_mask</span><span class="p">,</span> <span class="n">paste_position</span><span class="p">)</span>
            <span class="n">composite</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">composite</span><span class="p">(</span><span class="n">new_fg_image</span><span class="p">,</span> <span class="n">composite</span><span class="p">,</span> <span class="n">new_alpha_mask</span><span class="p">)</span>

            <span class="c1"># Grab the alpha pixels above a specified threshold</span>
            <span class="n">alpha_threshold</span> <span class="o">=</span> <span class="mi">200</span>
            <span class="n">mask_arr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="n">numpy</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">new_alpha_mask</span><span class="p">),</span> <span class="n">alpha_threshold</span><span class="p">),</span>
                <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">uint8_mask</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="n">mask_arr</span><span class="p">)</span>  <span class="c1"># This is composed of 1s and 0s</span>

            <span class="c1"># Multiply the mask value (1 or 0) by the color in each RGB channel and combine to get the mask</span>
            <span class="n">mask_rgb_color</span> <span class="o">=</span> <span class="n">fg</span><span class="p">[</span><span class="s2">&quot;mask_rgb_color&quot;</span><span class="p">]</span>
            <span class="n">red_channel</span> <span class="o">=</span> <span class="n">uint8_mask</span> <span class="o">*</span> <span class="n">mask_rgb_color</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">green_channel</span> <span class="o">=</span> <span class="n">uint8_mask</span> <span class="o">*</span> <span class="n">mask_rgb_color</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">blue_channel</span> <span class="o">=</span> <span class="n">uint8_mask</span> <span class="o">*</span> <span class="n">mask_rgb_color</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">rgb_mask_arr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">red_channel</span><span class="p">,</span> <span class="n">green_channel</span><span class="p">,</span> <span class="n">blue_channel</span><span class="p">))</span>
            <span class="n">isolated_mask</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">rgb_mask_arr</span><span class="p">,</span> <span class="s2">&quot;RGB&quot;</span><span class="p">)</span>
            <span class="n">isolated_alpha</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">uint8_mask</span> <span class="o">*</span> <span class="mi">255</span><span class="p">,</span> <span class="s2">&quot;L&quot;</span><span class="p">)</span>

            <span class="n">composite_mask</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">composite</span><span class="p">(</span>
                <span class="n">isolated_mask</span><span class="p">,</span> <span class="n">composite_mask</span><span class="p">,</span> <span class="n">isolated_alpha</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">composite</span><span class="p">,</span> <span class="n">composite_mask</span>

    <span class="k">def</span> <span class="nf">_transform_foreground</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fg</span><span class="p">,</span> <span class="n">fg_path</span><span class="p">):</span>
        <span class="c1"># Open foreground and get the alpha channel</span>
        <span class="n">fg_image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fg_path</span><span class="p">)</span>
        <span class="n">fg_alpha</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fg_image</span><span class="o">.</span><span class="n">getchannel</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">any</span><span class="p">(</span>
            <span class="n">fg_alpha</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;foreground needs to have some transparency: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">fg_path</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># ** Apply Transformations **</span>
        <span class="c1"># Rotate the foreground</span>
        <span class="n">angle_degrees</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">359</span><span class="p">)</span>
        <span class="n">fg_image</span> <span class="o">=</span> <span class="n">fg_image</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">angle_degrees</span><span class="p">,</span> <span class="n">resample</span><span class="o">=</span><span class="n">Image</span><span class="o">.</span><span class="n">BICUBIC</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Scale the foreground</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="mf">0.5</span>  <span class="c1"># Pick something between .5 and 1</span>
        <span class="n">new_size</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">fg_image</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">fg_image</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale</span><span class="p">))</span>
        <span class="n">fg_image</span> <span class="o">=</span> <span class="n">fg_image</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">new_size</span><span class="p">,</span> <span class="n">resample</span><span class="o">=</span><span class="n">Image</span><span class="o">.</span><span class="n">BICUBIC</span><span class="p">)</span>

        <span class="c1"># Adjust foreground brightness</span>
        <span class="n">brightness_factor</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.4</span> <span class="o">+</span> <span class="mf">0.7</span>
        <span class="p">)</span>  <span class="c1"># Pick something between .7 and 1.1</span>
        <span class="n">enhancer</span> <span class="o">=</span> <span class="n">ImageEnhance</span><span class="o">.</span><span class="n">Brightness</span><span class="p">(</span><span class="n">fg_image</span><span class="p">)</span>
        <span class="n">fg_image</span> <span class="o">=</span> <span class="n">enhancer</span><span class="o">.</span><span class="n">enhance</span><span class="p">(</span><span class="n">brightness_factor</span><span class="p">)</span>

        <span class="c1"># Add any other transformations here...</span>

        <span class="k">return</span> <span class="n">fg_image</span>

    <span class="k">def</span> <span class="nf">_create_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># A convenience wizard for automatically creating dataset info</span>
        <span class="c1"># The user can always modify the resulting .json manually if needed</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">silent</span><span class="p">:</span>
            <span class="c1"># No user wizard in silent mode</span>
            <span class="k">return</span>

        <span class="n">should_continue</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
            <span class="s2">&quot;Would you like to create dataset info json? (y/n) &quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">should_continue</span> <span class="o">!=</span> <span class="s2">&quot;y&quot;</span> <span class="ow">and</span> <span class="n">should_continue</span> <span class="o">!=</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No problem. You can always create the json manually.&quot;</span><span class="p">)</span>
            <span class="n">quit</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">ImageComposition</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Note: you can always modify the json manually if you need to update this.&quot;</span>
            <span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Description: &quot;</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;URL: &quot;</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Version: &quot;</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;contributor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Contributor: &quot;</span><span class="p">)</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">year</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;date_created&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">now</span><span class="o">.</span><span class="n">month</span><span class="si">:</span><span class="s2">0</span><span class="si">{</span><span class="mi">2</span><span class="si">}}</span><span class="s2">/</span><span class="si">{</span><span class="n">now</span><span class="o">.</span><span class="n">day</span><span class="si">:</span><span class="s2">0</span><span class="si">{</span><span class="mi">2</span><span class="si">}}</span><span class="s2">/</span><span class="si">{</span><span class="n">now</span><span class="o">.</span><span class="n">year</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">image_license</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">image_license</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">should_add_license</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Add an image license? (y/n) &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">should_add_license</span> <span class="o">!=</span> <span class="s2">&quot;y&quot;</span> <span class="ow">and</span> <span class="n">should_add_license</span> <span class="o">!=</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
            <span class="n">image_license</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">image_license</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">image_license</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;License name: &quot;</span><span class="p">)</span>
            <span class="n">image_license</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;License URL: &quot;</span><span class="p">)</span>

        <span class="n">dataset_info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">dataset_info</span><span class="p">[</span><span class="s2">&quot;info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span>
        <span class="n">dataset_info</span><span class="p">[</span><span class="s2">&quot;license&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">image_license</span>

        <span class="c1"># Write the JSON output file</span>
        <span class="n">output_file_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;dataset_info.json&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file_path</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
            <span class="n">json_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">dataset_info</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ImageComposition</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully created </span><span class="si">{</span><span class="n">output_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_and_process_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_generate_images</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_info</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ImageComposition</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Image composition completed.&quot;</span><span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">argparse</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Image Composition&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--input_dir&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;input_dir&quot;</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;The input directory. This contains a &#39;backgrounds&#39; directory of pngs or jpgs, and a &#39;foregrounds&#39; &quot;</span>
            <span class="s2">&quot;directory which contains super category directories (e.g. &#39;animal&#39;, &#39;vehicle&#39;), each of which contain &quot;</span>
            <span class="s2">&quot;category directories (e.g. &#39;horse&#39;, &#39;bear&#39;). Each category directory contains png images of that item on &quot;</span>
            <span class="s2">&quot;a transparent background (e.g. a grizzly bear on a transparent background).&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--output_dir&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;output_dir&quot;</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The directory where &quot;</span>
        <span class="s2">&quot;images, masks, </span><span class="se">\</span>
<span class="s2">                                                                             and json files will be placed&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--count&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;number of composed images to create&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--width&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;width&quot;</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;output image pixel width&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--height&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;height&quot;</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;output image pixel height&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--output_type&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;output_type&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;png or jpg (default)&quot;</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--silent&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;silent mode; doesn&#39;t prompt the user for input, automatically overwrites files&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">config</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="n">image_comp</span> <span class="o">=</span> <span class="n">ImageComposition</span><span class="p">()</span>
    <span class="n">image_comp</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../../../index.html">
              <img class="logo" src="../../../../../_static/header.png" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../../../../../index.html">neodroidvision</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../generated/neodroidvision.html">neodroidvision</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../getting_started.html">Getting Started</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../../index.html">Module code</a><ul>
  <li><a href="../../../../neodroidvision.html">neodroidvision</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.0.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>